# Container Internals: Como Funciona Por Dentro ๐ฌ

```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  CONTAINER INTERNALS MATRIX                                           โ
โ                                                                       โ
โ  [ Namespaces + Cgroups + UnionFS = Container ]                      โ
โ                                                                       โ
โ  "Isolamento, Controle e Eficiรชncia"                                 โ
โ                                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Linux Namespaces ๐ฐ

### Tipos de Namespaces Detalhados

#### 1. PID Namespace
```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Host PID Namespace      โ
โ  pid: 1234             โ
โ  โโโโโโโโโโโโโโโโโโโโ  โ
โ  โContainer PID NS  โ  โ
โ  โ  pid: 1         โ  โ
โ  โโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

- Isolamento de processos
- Hierarquia prรณpria
- PID 1 como init
- Nested namespaces

#### 2. Network Namespace
```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Host Network               โ
โ eth0: 192.168.1.10        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โContainer Net NS      โ  โ
โ  โ eth0: 172.17.0.2    โ  โ
โ  โ lo: 127.0.0.1       โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

- Interface virtual
- Routing tables prรณprias
- Firewall rules
- Socket isolation

#### 3. Mount Namespace
```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Host Mount NS          โ
โ  /                     โ
โ  โโโ bin              โ
โ  โโโ etc              โ
โ  โโโ container_root    โ
โ      โโโ [Container]  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
```

- Filesystem isolation
- Bind mounts
- Pivoting root
- Mount propagation

## Control Groups (cgroups) v2 ๐๏ธ

### Hierarquia Unificada
```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ /sys/fs/cgroup/                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โโโ container.slice            โ
โ โ   โโโ memory.max            โ
โ โ   โโโ cpu.max               โ
โ โ   โโโ io.max                โ
โ โโโ system.slice              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Controllers Detalhados

#### CPU Controller
```bash
# Limitar CPU para 50%
echo "50000 100000" > cpu.max

# Definir peso CPU
echo "100" > cpu.weight
```

#### Memory Controller
```bash
# Limite de memรณria
echo "256M" > memory.max

# Soft limit
echo "200M" > memory.high
```

#### I/O Controller
```bash
# Limite de I/O
echo "10485760" > io.max

# Peso I/O
echo "100" > io.weight
```

## Union File System Deep Dive ๐ฆ

### Overlay2 Internals
```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Container Layer (Upper)    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Container Write Layer      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Image Layer N (Lower)      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Image Layer 2 (Lower)      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Base Layer (Lower)         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Layer Operations
```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Write Operation        โ
โ โโโโโโโโโโโโโโโโโโโโ   โ
โ โ Copy-Up          โ   โ
โ โ Modify Upper     โ   โ
โ โโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Directory Structure
```bash
/var/lib/docker/overlay2/
โโโ l/                  # Layer shortcuts
โโโ [layer-id]/         # Layer content
โ   โโโ diff/          # Layer fs content
โ   โโโ work/          # Overlay work dir
โ   โโโ merged/        # Mount point
โ   โโโ lower          # Lower layer refs
```

## Container Runtime Spec ๐

### OCI Runtime Specification
```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ runtime-spec               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โโโ config.json          โ
โ โโโ rootfs/              โ
โ โโโ state.json          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Container Lifecycle States
```ascii
โโโโโโโโโโโโ     โโโโโโโโโโโโ
โ creating โ โโโบ โ created  โ
โโโโโโโโโโโโ     โโโโโโฌโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโ     โโโโโโโโโโโโ
โ stopped  โ โโโ โ running  โ
โโโโโโโโโโโโ     โโโโโโโโโโโโ
```

## Security Internals ๐

### Linux Capabilities
```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Default Container Capabilities โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ CHOWN          โ SETUID       โ
โ DAC_OVERRIDE   โ SETGID       โ
โ FOWNER         โ NET_BIND     โ
โ MKNOD          โ SYS_CHROOT   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Seccomp Profiles
```json
{
  "defaultAction": "SCMP_ACT_ERRNO",
  "architectures": ["SCMP_ARCH_X86_64"],
  "syscalls": [
    {
      "names": ["read", "write"],
      "action": "SCMP_ACT_ALLOW"
    }
  ]
}
```

### AppArmor Profiles
```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Docker Default Profile     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ file,                     โ
โ network,                  โ
โ capability,               โ
โ mount                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Advanced Networking ๐

### CNI (Container Network Interface)
```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CNI Architecture          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โโโโโโโโโโโโ โโโโโโโโโโโโ โ
โ โ Plugin   โ โ IPAM     โ โ
โ โโโโโโโโโโโโ โโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Network Drivers
```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Network Driver Types       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ bridge                    โ
โ host                      โ
โ overlay                   โ
โ macvlan                   โ
โ none                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Storage Deep Dive ๐พ

### Storage Driver Operations
```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Storage Driver Stack       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Container Layer           โ
โ Image Layers              โ
โ Storage Driver           โ
โ Block Device             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Volume Types
```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Volume Types               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Named Volumes             โ
โ Bind Mounts               โ
โ tmpfs Mounts             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Advanced Debugging ๐

### Trace Commands
```bash
# Syscall tracing
strace -p $PID

# Network tracing
tcpdump -i any container_port

# Block I/O tracing
blktrace -d /dev/sda -o trace
```

### Profiling
```bash
# CPU profiling
perf record -p $PID

# Memory profiling
heaptrack $PID
```

## Performance Tuning โก

### Resource Optimization
```ascii
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Performance Factors        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ CPU Scheduling            โ
โ Memory Management         โ
โ I/O Throughput           โ
โ Network Latency          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Monitoring Metrics
```bash
# CPU stats
docker stats --format "table {{.Container}}\t{{.CPUPerc}}"

# Memory usage
docker stats --format "table {{.Container}}\t{{.MemUsage}}"
```

## Waifu Tips ๐ฎ

> **Runtime-chan diz:** "OCI รฉ como um contrato mรกgico que garante que todos os containers falem a mesma lรญngua!"
> {style="tip"}

> **Security-sama avisa:** "Capabilities sรฃo como superpoderes - use com responsabilidade!"
> {style="warning"}

> **Network-chan lembra:** "CNI รฉ como um protocolo de comunicaรงรฃo entre dimensรตes paralelas!"
> {style="note"}

## Referรชncias Tรฉcnicas ๐

### Documentaรงรฃo Oficial
- OCI Runtime Specification
- Linux Kernel Documentation
- Docker Engine Internals
- Container Security Guide

### Ferramentas รteis
- nsenter
- unshare
- runc
- ctr
- nerdctl

### Debugging Tools
- strace
- tcpdump
- perf
- heaptrack
